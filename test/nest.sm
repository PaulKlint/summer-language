# test nesting of try/scan/return constructs #

include 'heading.sm';

proc p(a) scan 'abc' for lit('ab'); return(a || a); rof;

proc q() scan 'abc' for lit('ab'); freturn rof;

proc r(a) try (return(a || a); 1 = 1) yrt;

proc s() try (1 = 1; freturn) yrt;

proc t() scan 'abc' for try (1 = 1; return(5) ) yrt rof;

proc u() try scan 'abc' for return(6) rof yrt;

proc v() try 1 = 1 until return(7) yrt;

proc w() try 1 = 1 until freturn yrt;

program nest()
( var n;

  start('nest');
  test(n := 0);
  if scan 'abc' for lit('xx') rof = 'yy' then error(n+0) fi;
  if 'yy' = scan 'abc' for lit('xx') rof then error(n+1) fi;
  if scan 'abc' for lit('ab') rof ~= 'ab' then error(n+2) fi;

  test(n := 10);
  if p('X') ~= 'XX' then error(n+0) fi;
  if q then error(n+1) fi;

  test(n := 20);

  if try 1 = 1 yrt ~= 1 then error(n+0) fi;
  if try 1 = 2 yrt = 1 then error(n+1) fi;

  test(n := 30);
  if r('X') ~= 'XX' then error(n+0) fi;
  if s then error(n+1) fi;

  test(n := 40);
  if scan 'abc' for try 1 = 1 yrt rof ~= 1 then error(n+0) fi;
  if scan 'abc' for try 1 ~= 1 yrt rof = 1 then error(n+1) fi;

  test(n := 50);
  if try scan 'abc' for lit('xx') rof yrt = 'xx' then error(n+0) fi;
  if try scan 'abc' for lit('ab') rof ~= 'ab' yrt = 'ab' then error(n+1) fi;

  test(n := 60);
  if t ~= 5 then error(n+0) fi;
  if u ~= 6 then error(n+1) fi;
  if v ~= 7 then error(n+2) fi;
  if w then error(n+3) fi;

  finish('nest');
)
