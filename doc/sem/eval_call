.iy I BEGIN
.iy I CLASS
.iy I END
.iy I ENV
.iy I ENVglobal
.iy I ERROR
.iy I F
.iy I FR
.iy I INIT
.iy I N
.iy I NR
.iy I PROC
.iy I STATE
.iy I a_undefined
.iy I bind
.iy I binding
.iy I eval
.iy I eval_call
.iy I eval_standard_procedure
.iy I extend
.iy I index
.iy I is_class
.iy I is_proc
.iy I name_copy
.iy I names
.iy I new_inner_scope
.iy I new_proc_scope
.iy I self
.iy I size
.iy I text
.iy I type
.{{
\fBproc\fR \jg\fIeval\*_call\fR\^(\^\fIprocname\fR, \fIactuals\fR)
\z(  \jh\fBvar\fR \ji\fIprocdef\fR;
.sp 0.5
\h'|\nhu'\fBif\fR \jg\fIprocname\fR = \*`\fI\h'-0.1m'string\fR\^\*' | \fIprocname\fR = \*`\fI\h'-0.1m'integer\fR\^\*' |
\h'|\ngu'\fIprocname\fR = \*`\fI\h'-0.1m'undefined\^\fR\^\*' | \fIprocname\fR = \*`\fI\h'-0.1m'type\fR\^\*'
\h'|\nhu'\fBthen\fR
\h'|\ngu'\fIreturn\fR\^(\^[\fIeval\*_standard\*_procedure\fR\^(\^\fIprocname\fR, \fIactuals\fR), \fIN\fR\|]\^)
\h'|\nhu'\fBfi\fR;
\h'|\nhu'\fIprocdef\fR := \fIENV\fR.\fIbinding\fR\^(\^\fIprocname\fR);
\h'|\nhu'\fBif\fR \jg\fIis\*_proc\fR\^(\^\fIprocdef\fR\|\|)
\h'|\nhu'\fBthen\fR
\h'|\ngu'\fBvar\fR \jj\fIbody\fR, \fIENV\fR1, \fIformals\fR, \fIi\fR, \fIv\fR, \fIsig\fR;
.sp 0.5
\h'|\ngu'{{ \fIprocdef\fR.\fItext\fR =\h'-0.3m'=
             \jk\s-2PROC\s0  \jl\*<identifier\*> \*`\fI\z( \jm\fR\^\*' \fIformals\fR: {\*<identifier\*> \*`\fI,\fR\^\*'}\v'0.25m'*\v'-0.25m' \*`\fI)\fR\^\*'
\h'|\nku'\fIbody\fR: [\*<expression\*>] \*`\fI;\fR\^\*'
\h'|\ngu'}};
\h'|\ngu'\fBif\fR \jn\fIactuals\fR.\fIsize\fR \(ap\h'-0.2m'= \fIformals\fR.\fIsize\fR \fBthen\fR \jo\fIERROR\fR \fBfi\fR;
\h'|\ngu'\fIENV\fR1 := \fIENV\fR;
\h'|\ngu'\fIENV\fR := \fIprocdef\fR.\fIenv\fR.\fIname\*_copy\fR;
\h'|\ngu'\fIENV\fR.\fInew\*_proc\*_scope\fR;
\h'|\ngu'\fBfor\fR \jj\fIi\fR \fBin\fR \jp\fIactuals\fR.\fIindex\fR
\h'|\ngu'\fBdo\fR \jn\fIENV\fR.\fIbind\fR\^(\|\|\fIformals\fR\^[\fIi\fR\|], \fISTATE\fR.\fIextend\fR\^(\fIactuals\fR\^[\fIi\fR\|]\^)) \fBod\fR;
\h'|\ngu'[\fIv\fR, \fIsig\fR] := \fIeval\fR\^(\fIbody\fR);
\h'|\ngu'\fIENV\fR := \fIENV\fR1;
\h'|\ngu'\fBcase\fR \jq\fIsig\fR
\h'|\ngu'\fBof\fR \jn\fIN\fR: \fINR\fR:  \jr\fIreturn\fR\^(\^[\fIv\fR, \fIN\fR\|]\^),
\h'|\nnu'\fIF\fR: \fIFR\fR:\h'|\nru'\fIreturn\fR\^(\^[\fIv\fR, \fIF\fR\|]\^)
\h'|\ngu'\fBesac\fR
\h'|\nhu'\fBelse\fR
\h'|\ngu'\*# is\*_class(\^procdef) \js\*#
\h'|\ngu'\fBvar\fR \jj\fIformals\fR, \fIdecls\fR, \fIinitexpr\fR, \fIENV\fR1, \fIvarinit\fR1;
\h'|\ngu'\fBvar\fR \jj\fIname\fR, \fIinstance\fR, \fId\fR, \fIv\fR, \fIsig\fR, \fIexpr\fR, \fIi\fR;
.sp 0.5
\h'|\ngu'{{ \fIprocdef\fR.\fItext\fR =\h'-0.3m'=
           \jt\s-2CLASS\s0 \ju\*<identifier\*> \*`\fI\z( \jm\fR\^\*' \fIformals\fR:{\*<identifier\*> \*`\fI,\fR\^\*'}\v'0.25m'*\v'-0.25m' \*`\fI)\fR\^\*'
\h'|\ntu'\s-2BEGIN\s0 \ju\*<fetch-associations\*> \*<store-associations\*>
\h'|\ntu'\fIdecls\fR:\h'|\nlu'(  \jv\*<variable-declaration\*> | \*<constant-declaration\*> |
\h'|\nvu'\*<procedure-declaration\*> | \*<operator-declaration\*>
\h'|\nlu')\v'0.25m'*\v'-0.25m'
\h'|\ntu'\fIinitexpr\fR:\h'|\nvu'[\s-2INIT\s0 \jw\*`\fI:\fR\^\*' \*<block\*>]
\h'|\ntu'\s-2END\s0 \jx\*<identifier\*> \*`\fI;\fR\^\*'
\h'|\ngu'}};
\h'|\ngu'\fIENV\fR1 := \fIENV\fR;
\h'|\ngu'\fIENV\fR := \fIENVglobal\fR.\fIname\*_copy\fR;
\h'|\ngu'\fIENV\fR.\fInew\*_inner\*_scope\fR;
\h'|\ngu'\fIvarinit\fR1 := \fIvarinit\fR;
\h'|\ngu'\fIvarinit\fR := \*`\fI\fR\^\*';
\h'|\ngu'\fBif\fR \jn\fIactuals\fR.\fIsize\fR \(ap\h'-0.2m'= \fIformals\fR.\fIsize\fR \fBthen\fR \jo\fIERROR\fR \fBfi\fR;
\h'|\ngu'\fBfor\fR \jj\fIi\fR \fBin\fR \jp\fIactuals\fR.\fIindex\fR
\h'|\ngu'\fBdo\fR \jn\fIENV\fR.\fIbind\fR\^(\|\|\fIformals\fR\^[\fIi\fR\|], \fISTATE\fR.\fIextend\fR\^(\fIactuals\fR\^[\fIi\fR\|]\^)) \fBod\fR;
.sp 0.5
\h'|\ngu'\fBfor\fR \jj\fId\fR \fBin\fR \jp\fIdecls\fR
\h'|\ngu'\fBdo\fR \jn[\fIv\fR, \fIsig\fR] := \fIeval\fR\^(\fId\fR\|);
\h'|\nnu'\fBif\fR \jt\fIsig\fR \(ap\h'-0.2m'= \fIN\fR \fBthen\fR \js\fIERROR\fR \fBfi\fR
\h'|\ngu'\fBod\fR;
\h'|\ngu'\fBfor\fR \jj\fIname\fR \fBin\fR \ju\fIENV\fR.\fInames\fR
\h'|\ngu'\fBdo\fR \jn\fBvar\fR \jy\fIb\fR := \fIENV\fR.\fIbinding\fR\^(\fIname\fR);
\h'|\nnu'\fBif\fR \jt\fIis\*_proc\fR\^(\fIb\fR) & \fIb\fR.\fIenv\fR = \fIundefined\fR \fBthen\fR \jz\fIb\fR.\fIenv\fR := \fIENV\fR \fBfi\fR
\h'|\ngu'\fBod\fR;
.sp 0.5
\h'|\ngu'\fIinstance\fR := \fIa\*_composite\*_instance\fR\^(\^\fIprocdef\fR, \fIENV\fR\|);
\h'|\ngu'\fIENV\fR.\fIbind\fR\^(\*`\fI\h'-0.1m'self\^\fR\^\*', \fIinstance\fR);
\h'|\ngu'[\fIv\fR, \fIsig\fR] := \fIeval\fR\^(\fIvarinit\fR);
\h'|\ngu'\fIvarinit\fR := \fIvarinit\fR1;
\h'|\ngu'\fBif\fR \jn\fIsig\fR \(ap\h'-0.2m'= \fIN\fR
\h'|\ngu'\fBthen\fR
\h'|\nnu'\fIENV\fR := \fIENV\fR1;
\h'|\nnu'\fBcase\fR \jk\fIsig\fR
\h'|\nnu'\fBof\fR \jt\fIF\fR:\h'|\nru'\fIERROR\fR,
\h'|\ntu'\fIFR\fR:\h'|\nru'\fIreturn\fR\^(\^[\fIv\fR, \fIF\fR\|]\^),
\h'|\ntu'\fINR\fR:\h'|\nru'\fIreturn\fR\^(\^[\fIv\fR, \fIN\fR\|]\^)
\h'|\nnu'\fBesac\fR
\h'|\ngu'\fBfi\fR;
\h'|\ngu'\fBif\fR \jn{{ \fIinitexpr\fR =\h'-0.3m'= \jA\s-2INIT\s0 \jw\*`\fI:\fR\^\*' \fIexpr\fR:\*<block\*> }}
\h'|\ngu'\fBthen\fR
\h'|\nnu'\fIENV\fR.\fInew\*_proc\*_scope\fR;
\h'|\nnu'[\fIv\fR, \fIsig\fR] := \fIeval\fR\^(\fIexpr\fR);
\h'|\ngu'\fBelse\fR
\h'|\nnu'[\fIv\fR, \fIsig\fR] := [\fIa\*_undefined\fR, \fIN\fR\|]
\h'|\ngu'\fBfi\fR;
\h'|\ngu'\fIENV\fR := \fIENV\fR1;
\h'|\ngu'\fBcase\fR \jq\fIsig\fR
\h'|\ngu'\fBof\fR \jn\fIF\fR: \fIFR\fR:\h'|\nru'\fIreturn\fR\^(\^[\fIv\fR, \fIF\fR\|]\^),
\h'|\nnu'\fIN\fR: \fINR\fR:\h'|\nru'\fIreturn\fR\^(\^[\fIinstance\fR, \fIN\fR\|]\^)
\h'|\ngu'\fBesac\fR
\h'|\nhu'\fBfi\fR
);
.}}
.iy I BEGIN
.iy I CLASS
.iy I END
.iy I ENV
.iy I ENVglobal
.iy I ERROR
.iy I F
.iy I FR
.iy I INIT
.iy I N
.iy I NR
.iy I PROC
.iy I STATE
.iy I a_undefined
.iy I bind
.iy I binding
.iy I eval
.iy I eval_call
.iy I eval_standard_procedure
.iy I extend
.iy I index
.iy I is_class
.iy I is_proc
.iy I name_copy
.iy I names
.iy I new_inner_scope
.iy I new_proc_scope
.iy I self
.iy I size
.iy I text
.iy I type
