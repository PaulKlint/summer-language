# Makefile for SUMMER documentation.
#
# Rules related to reference manual
# Note that the index and table of contents are generated by a
# two-stage nroff sequence: first the refence manual is nroff-ed
# and at the same index info is generated on the error stream, which
# is redirected to "index.all". Next parts from index.all are
# selected and nroff-ed to produce index and contents.
MANTEXT=manpref.ms summer.ms refman1.ms refman2.ms library.ms anno?.ms tracer.ms syntax.ms
PART1=preface.ms partI.ms intro.ms bt.ms summer.ms pragma.ms epi.ms
PART2=partII.ms manprefth.ms refman1.ms refman2.ms library.ms anno?.ms syntax.ms
MAC=-ms ix.ms


part2:	$(PART2)
	Make1 $(PART2) >part2.out

refman:	refman1.ms refman2.ms
	Make1 refman1.ms refman2.ms >refman.out

library: library.ms
	@Make1 library.ms >library.out

anno:	anno?.ms
	(echo ".{{"; cat ../demo/flex.sm ; echo ".}}") >.t
	Boldkw <.t >../demo/flex.so
	(echo ".{{"; cat ../demo/tuples.sm;echo ".}}") >.t
	Boldkw <.t >../demo/tuples.so
	sed "s/  */	/" <../demo/tuples.out >../demo/tuples.out.so
	(cat ../demo/flex.out; echo "") | sed "s/: */:	/;s/ /\\\\0/g" >../demo/flex.out.so
	@Make1 anno?.ms >anno.out

syntax:	syntax.ms summer.syn
	syn/MKGRAM >syntax.ms
	Make1 syntax.ms >syntax.out
manual:	$(MANTEXT)
	iref counters $(MANTEXT) >.t
	(cat ix.ms; Boldkw <.t) | eqn > .tt
	nroff -Tdick -ms .tt 2>index.all | ital >man.out
# create table of contents #
	echo .so firstpage >.t
	echo .DS C >>.t
	echo TABLE OF CONTENTS >>.t
	echo .DE >>.t
	echo .LP >>.t
	echo ".Ib" >>.t
	grep ".In C" <index.all | grep -v "\.[abcdefg]\. " | nroff -ms index.ms .t - >contents
	rm .t
# create index #
	echo .DS C >.t
	echo INDEX >>.t
	echo .DE >>.t
	echo .LP >>.t
	echo ".Ib" >>.t
	echo ".2C" >>.t
	grep "In I" <index.all | sort -t\" +1 -2 +2n | uniq >>.t
	echo .Ie >>.t
	nroff -ms index.ms .t >index
	rm .t

print: manual
	cat contents
	cat man.out
	col <index
# rules related to some separate papers
compiler:	compiler.ms
	nroff -ms compiler.ms

summer:	summer.ms
	Make1 summer.ms >summer.out
preface:preface.ms
	Make1 preface.ms >preface.out
intro:	intro.ms
	Make1 intro.ms >intro.out
spring:	spring.ms
	Make1 spring.ms >spring.out
bt:	bt.ms
	Make1 bt.ms >bt.out
pragma:	pragma.ms
	Make1 pragma.ms >pragma.out
impl:	impl.ms
	Make1 impl.ms >impl.out
epi:	epi.ms
	Make1 epi.ms >epi.out
part1:  $(PART1)
	Make1 $(PART1) >part1.out
springer:$(PART1) $(PART2)
	Make1 $(PART1) $(PART2)
contents:
	echo .DS C >.t
	echo CONTENTS >>.t
	echo .DE >>.t
	echo .LP >>.t
	echo ".sp 4" >>.t
	echo "PART I: From SPRING to SUMMER" >>.t
	echo ".sp 2" >>.t
	echo ".Ib" >>.t
	grep ".In C" <index.all | grep -v "\.[abcdefg]\. " >>.t
	ed - .t <ed.partII
	troff -t /summer/jan/format/mctract index.ms .t >contents
	rm .t

# Following rules are only intended for local use;
# not all source files are on the distribution tape.
FORMDEF=formdef.sm
f:	f.sm
	(sumc f >out; echo )&
f.sm:	parsgen lex.sm summer.syn $(FORMDEF)
	parsgen lex.sm summer.syn $(FORMDEF) >f.sm
summer.syn:
	(cd syn; RUN >../summer.syn)
match:	match.sm
	sumc match.sm
match.sm:	parsgen lex.sm match.syn match.def
	parsgen lex.sm match.syn match.def >match.sm
parsgen:	parsgen.sm
	sumc parsgen.sm
	mv a.out parsgen
# end of local rules
