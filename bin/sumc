#!/bin/sh
: sumc -- SUMMER compiler

: The shell variables have the following meaning
: SUMMERBIN	- directory where the standard SUMMER system resides.
: PARSER	- the SUMMER compiler
: INT		- the SUMMER interpreter
: CC		- C compiler to be used either "cc" or "pcc".
: errors	- remembers error states during compilation, used on exit
: prog		- the SUMMER source program
: aout		- the object program
SUMMERBIN=/userfs2/gipe/paulk/sys/bin
CC=cc
PARSER=${PARSER-$SUMMERBIN/parser}
INT=${INT-$SUMMERBIN/int.a}
errors=1
: Check for -o flag, if present extract object program name
if /bin/test x$1x = x-ox
then	aout=$2
	shift; shift
else	aout=a.out
fi
: Next extract the name of the source file "prog" from the argument list.
prog=$1
if /bin/test x${prog}x = xx
then
	echo "Usage: sumc file"
	exit
fi
base=`basename $prog .sm`
: if basename modified "prog" and "prog" was not of the form $base.sm
: we must recover the lost prefix
if /bin/test $prog != $base -a $prog != $base.sm
then	dir=`echo $prog | sed "s/[^\/]*$//"`
fi
prog=$dir$base
: Be prepared to remove intermediate files on unexpected signals.
: Quit leaves all files intact
trap "rm $prog.s $prog.o >/dev/null" 1 2 4 5 6 7 8 9 10 11 12 13 14 15
: Parse the program. Error messages are written to "prog.er".
if $PARSER -s4000 -m80000 $prog
then	rm $prog.er
	as -o $prog.o $prog.s
	cc -o $aout $prog.o $INT
	if /bin/test $prog != parser
	then	rm $prog.o $prog.s
	fi
	errors=0
else	if /bin/test -r $prog.er
	then	cat $prog.er
	fi
	if /bin/test -r $prog.s
	then	rm $prog.s
	fi
fi
exit $errors
